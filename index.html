<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Academic Literacy Chat</title>
    <style>
      :root { 
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; 
      }
      html, body { 
        margin: 0; 
        padding: 0; 
        height: 100%; 
        background: #000; 
        color: #fff; 
        overflow: hidden; 
      }
      .wrap { 
        height: 100%; 
        display: flex; 
        flex-direction: column; 
        padding: 24px; 
        box-sizing: border-box; 
      }
      h1 { 
        font-size: 1.5rem; 
        margin: 0 0 16px; 
        color: #fff; 
      }
      .chat { 
        flex: 1; 
        background: #000; 
        border: 1px solid #333; 
        border-radius: 12px; 
        padding: 16px; 
        overflow-y: auto; 
        margin-bottom: 16px; 
        box-sizing: border-box; 
      }
      .msg { 
        padding: 12px 14px; 
        border-radius: 10px; 
        margin: 8px 0; 
        line-height: 1.4; 
        white-space: pre-wrap; 
        max-width: 85%; 
      }
      .user { 
        background: #1e293b; 
        margin-left: auto; 
        color: #e5e7eb; 
      }
      .assistant { 
        background: #0b3d2e; 
        color: #e5e7eb; 
      }
      form { 
        display: flex; 
        gap: 8px; 
        margin-top: 8px; 
      }
      textarea { 
        flex: 1; 
        padding: 10px 12px; 
        border-radius: 10px; 
        border: 1px solid #333; 
        background: #000; 
        color: #fff; 
        min-height: 56px; 
        resize: vertical; 
        font-size: 1rem; 
      }
      button { 
        padding: 10px 16px; 
        border-radius: 10px; 
        border: 1px solid #333; 
        background: #333; 
        color: #fff; 
        cursor: pointer; 
        font-size: 1rem; 
      }
      button:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
      }
      .error { 
        color: #fecaca; 
        margin-top: 8px; 
        font-size: 0.9rem; 
      }
      a { 
        color: #93c5fd; 
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Ask questions about academic literacy</h1>
      <div id="chat" class="chat" role="log" aria-live="polite"></div>
      <form id="form">
        <textarea id="input" placeholder="Type your messageâ€¦" aria-label="Message"></textarea>
        <button id="send" type="submit">Send</button>
      </form>
      <div id="err" class="error" aria-live="polite"></div>
    </div>

    <script>
      async function sendMessage(message) {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ messages: [{ role: "user", content: message }] })
        });

        const text = await res.text(); // safer parsing
        if (!text) throw new Error(`Empty response (HTTP ${res.status})`);

        let data;
        try { data = JSON.parse(text); }
        catch { throw new Error("Server did not return valid JSON"); }

        if (!res.ok) throw new Error(data?.error || `HTTP ${res.status}`);
        return data;
      }

      const chat = document.getElementById("chat");
      const form = document.getElementById("form");
      const input = document.getElementById("input");
      const sendBtn = document.getElementById("send");
      const err = document.getElementById("err");

      function addMessage(role, content) {
        const div = document.createElement("div");
        div.className = "msg " + (role === "user" ? "user" : "assistant");
        div.textContent = content;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        err.textContent = "";
        const text = input.value.trim();
        if (!text) return;

        addMessage("user", text);
        input.value = "";
        input.focus();
        sendBtn.disabled = true;

        try {
          const data = await sendMessage(text);
          const reply = data?.choices?.[0]?.message?.content ?? "(No response)";
          addMessage("assistant", reply);
        } catch (ex) {
          err.textContent = ex.message || "Request failed";
        } finally {
          sendBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
